<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India COâ‚‚ Emissions Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 6px;
      line-height: 1.5;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
      font-size: 14px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ================= MAP ================= */
    const map = L.map("map").setView([22.5, 79], 5);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles Â© Esri" }
    ).addTo(map);

    /* ================= SECTORS ================= */
    const sectors = {
      Power: {
        file: "data/co2_emissions_2024_summary_power.csv",
        color: "#00bcd4"
      },
      Cement: {
        file: "data/co2_emissions_2024_summary_cement.csv",
        color: "#ff9800"
      },
      Steel: {
        file: "data/co2_emissions_2024_summary_steel.csv",
        color: "#9c27b0"
      },
      Refinery: {
        file: "data/co2_emissions_2024_summary_refinery.csv",
        color: "#4caf50"
      },
      Fertilisers: {
        file: "data/co2_emissions_2024_summary_fertilisers.csv",
        color: "#f44336"
      }
    };

    const layers = {};
    const sectorTotals = {};
    const sectorCounts = {};   // ðŸ”¹ NEW

    /* ================= LOAD CSVs ================= */
    function loadSector(sectorName, config) {
      const layer = L.layerGroup();
      layers[sectorName] = layer;

      let sectorSum = 0;
      let plantCount = 0;

      Papa.parse(config.file, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function (results) {
          results.data.forEach(row => {
            if (!row.lat || !row.lon) return;

            const emissions = row.total_co2_emissions_2024 || 0;
            sectorSum += emissions;
            plantCount++;

            const radius = Math.max(3, Math.log(emissions + 1));

            const marker = L.circleMarker(
              [row.lat, row.lon],
              {
                radius,
                color: config.color,
                fillColor: config.color,
                fillOpacity: 0.7,
                weight: 0
              }
            )
            .bindTooltip(
              `
              <strong>${row.source_name}</strong><br>
              COâ‚‚ (2024): ${(emissions / 1e6).toFixed(2)} Mt
              `,
              {
                direction: "top",
                offset: [0, -6],
                sticky: true,
                opacity: 0.9
              }
            )
            .bindPopup(`
              <strong>${row.source_name}</strong><br>
              Sector: ${sectorName}<br>
              COâ‚‚ (2024): ${emissions.toLocaleString()} t<br>
              Source ID: ${row.source_id}
            `);

            marker.on("mouseover", function () {
              this.setStyle({ weight: 2, fillOpacity: 0.9 });
            });
            marker.on("mouseout", function () {
              this.setStyle({ weight: 0, fillOpacity: 0.7 });
            });

            marker.addTo(layer);
          });

          sectorTotals[sectorName] = sectorSum;
          sectorCounts[sectorName] = plantCount;

          layer.addTo(map);
          updateTotalCO2();
          updatePlantCount();
        }
      });
    }

    Object.entries(sectors).forEach(([name, cfg]) => {
      loadSector(name, cfg);
    });

    /* ================= LAYER TOGGLE ================= */
    L.control.layers(null, layers, { collapsed: false }).addTo(map);

    /* ================= LEGEND ================= */
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<strong>Sectors</strong><br>";
      Object.entries(sectors).forEach(([name, cfg]) => {
        div.innerHTML += `<span style="background:${cfg.color}"></span>${name}<br>`;
      });
      return div;
    };
    legend.addTo(map);

    /* ================= TOTAL COâ‚‚ CONTROL ================= */
    const totalCO2Control = L.control({ position: "bottomleft" });

    totalCO2Control.onAdd = function () {
      this._div = L.DomUtil.create("div", "legend");
      this.update(0);
      return this._div;
    };

    totalCO2Control.update = function (totalTonnes) {
      const mt = totalTonnes / 1e6;
      this._div.innerHTML = `
        <strong>Total COâ‚‚ (2024)</strong><br>
        ${mt.toLocaleString(undefined, { maximumFractionDigits: 2 })} Mt COâ‚‚
      `;
    };

    totalCO2Control.addTo(map);

    function updateTotalCO2() {
      let total = 0;
      Object.keys(layers).forEach(sector => {
        if (map.hasLayer(layers[sector])) {
          total += sectorTotals[sector] || 0;
        }
      });
      totalCO2Control.update(total);
    }

    /* ================= PLANT COUNT CONTROL ================= */
    const plantCountControl = L.control({ position: "bottomright" });

    plantCountControl.onAdd = function () {
      this._div = L.DomUtil.create("div", "legend");
      this.update(0);
      return this._div;
    };

    plantCountControl.update = function (count) {
      this._div.innerHTML = `
        <strong>Total Plants</strong><br>
        ${count.toLocaleString()}
      `;
    };

    plantCountControl.addTo(map);

    function updatePlantCount() {
      let count = 0;
      Object.keys(layers).forEach(sector => {
        if (map.hasLayer(layers[sector])) {
          count += sectorCounts[sector] || 0;
        }
      });
      plantCountControl.update(count);
    }

    /* ================= EVENTS ================= */
    map.on("overlayadd overlayremove", function () {
      updateTotalCO2();
      updatePlantCount();
    });
  </script>
</body>
</html>
