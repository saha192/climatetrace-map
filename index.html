<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India CO₂ Emissions Map (Climate Trace Style)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 6px;
      line-height: 1.5;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ---------------- MAP ---------------- */
    const map = L.map("map").setView([22.5, 79], 5);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles © Esri" }
    ).addTo(map);

    /* ---------------- SECTORS ---------------- */
    const sectors = {
      Power: {
        file: "data/co2_emissions_2024_summary_power.csv",
        color: "#00bcd4"
      },
      Cement: {
        file: "data/co2_emissions_2024_summary_cement.csv",
        color: "#ff9800"
      },
      Steel: {
        file: "data/co2_emissions_2024_summary_steel.csv",
        color: "#9c27b0"
      },
      Refinery: {
        file: "data/co2_emissions_2024_summary_refinery.csv",
        color: "#4caf50"
      },
      Fertilisers: {
        file: "data/co2_emissions_2024_summary_fertilisers.csv",
        color: "#f44336"
      }
    };

    const layers = {};
    const sectorTotals = {};

    /* ---------------- LOAD CSVs ---------------- */
    function loadSector(sectorName, config) {
      const layer = L.layerGroup();
      layers[sectorName] = layer;
      let sectorSum = 0;

      Papa.parse(config.file, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function (results) {
          results.data.forEach(row => {
            if (!row.lat || !row.lon) return;

            const emissions = row.total_co2_emissions_2024 || 0;
            sectorSum += emissions;

            const radius = Math.max(3, Math.log(emissions + 1));

            const marker = L.circleMarker(
              [row.lat, row.lon],
              {
                radius,
                color: config.color,
                fillColor: config.color,
                fillOpacity: 0.7,
                weight: 0
              }
            ).bindPopup(`
              <strong>${row.source_name}</strong><br>
              Sector: ${sectorName}<br>
              CO₂ (2024): ${emissions.toLocaleString()} t<br>
              Source ID: ${row.source_id}
            `);

            marker.addTo(layer);
          });

          sectorTotals[sectorName] = sectorSum;
          layer.addTo(map);
          updateTotalControl();
        }
      });
    }

    Object.entries(sectors).forEach(([name, cfg]) => {
      loadSector(name, cfg);
    });

    /* ---------------- LAYER CONTROL ---------------- */
    L.control.layers(null, layers, { collapsed: false }).addTo(map);

    /* ---------------- LEGEND ---------------- */
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<strong>Sectors</strong><br>";
      Object.entries(sectors).forEach(([name, cfg]) => {
        div.innerHTML += `<span style="background:${cfg.color}"></span>${name}<br>`;
      });
      return div;
    };
    legend.addTo(map);

    /* ---------------- TOTAL CO₂ CONTROL ---------------- */
    const totalControl = L.control({ position: "bottomleft" });

    totalControl.onAdd = function () {
      this._div = L.DomUtil.create("div", "legend");
      this.update(0);
      return this._div;
    };

    totalControl.update = function (totalTonnes) {
      const mt = totalTonnes / 1e6;
      this._div.innerHTML = `
        <strong>Total CO₂ (2024)</strong><br>
        ${mt.toLocaleString(undefined, { maximumFractionDigits: 2 })} Mt CO₂
      `;
    };

    totalControl.addTo(map);

    /* ---------------- UPDATE TOTAL ---------------- */
    function updateTotalControl() {
      let total = 0;
      Object.keys(layers).forEach(sector => {
        if (map.hasLayer(layers[sector])) {
          total += sectorTotals[sector] || 0;
        }
      });
      totalControl.update(total);
    }

    map.on("overlayadd overlayremove", updateTotalControl);
  </script>
</body>
</html>
